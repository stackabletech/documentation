name: Build site

on:
  pull_request:

jobs:

  build:
    runs-on: ubuntu-latest
    env:
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # tag=v3.0.2
        with:
          submodules: true
          fetch-depth: 0
      - uses: actions/setup-node@1f8c6b94b26d0feae1e387ca63ccbdc44d27b561 # tag=v2
        with:
          node-version: '16'
          cache: 'npm'
      - run: npm ci
      - run: make ANTORAFLAGS=--fetch
      - name: Publish to nexus
        if: env.NEXUS_PASSWORD != null # pragma: allowlist secret
        run: >-
          /usr/bin/find 
          build/site -name '*' -type f -exec 
          curl --fail --user 'github:${{ secrets.NEXUS_PASSWORD }}'
          --upload-file {} 
          https://repo.stackable.tech/repository/docs/pr${{ github.event.pull_request.number }}/{} \;
      - name: Comment PR
        if: github.event.action == opened
        uses: thollander/actions-comment-pull-request@v1
        with:
          GITHUB_TOKEN: ${{ secrets.STACKY_MC_STACKFACE_TOKEN }}
          message: 'View the docs in this PR [rendered online](https://repo.stackable.tech/repository/docs/pr${{ github.event.pull_request.number }}/build/site/index.html)'